<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Floating Energy Core â€“ Containment Cylinder</title>

    <script src="../COMMON/webgl-utils.js"></script>
    <script src="../COMMON/initShaders.js"></script>
    <script src="../COMMON/MV.js"></script>

    <script src="core-geometry.js"></script>
    <script src="shard-geometry.js"></script>
    <script src="cylinder-geometry.js"></script>
    <script src="main.js"></script>

    <script id="vertex-shader" type="x-shader/x-vertex">
        attribute vec4 vPosition;
        attribute vec3 aNormal;
        attribute vec2 vTexCoord;

        uniform mat4 uModel;
        uniform mat4 uView;
        uniform mat4 uProjection;
        uniform mat3 uNormalMatrix;

        varying vec3 fNormal;
        varying vec3 fPosition;
        varying vec2 fTexCoord;

        void main() {
            fPosition = (uView * uModel * vPosition).xyz;
            fNormal = normalize(uNormalMatrix * aNormal);
            fTexCoord = vTexCoord;
            gl_Position = uProjection * uView * uModel * vPosition;
        }
    </script>

    <script id="fragment-shader" type="x-shader/x-fragment">
        precision mediump float;

        varying vec3 fNormal;
        varying vec3 fPosition;
        varying vec2 fTexCoord;

        uniform vec3 uLightPos;
        uniform vec3 uCameraPos;

        uniform vec4 uAmbient;
        uniform vec4 uDiffuse;
        uniform vec4 uSpecular;
        uniform float uShininess;

        uniform bool uUseTexture;
        uniform sampler2D uTexture;

        uniform float uAlpha; 

        void main() {
            vec3 N = normalize(fNormal);
            vec3 L = normalize(uLightPos - fPosition);
            vec3 V = normalize(uCameraPos - fPosition);
            vec3 H = normalize(L + V);

            float diff = max(dot(N, L), 0.0);
            float spec = pow(max(dot(N, H), 0.0), uShininess);

            vec4 texColor = vec4(1.0);
            if (uUseTexture) {
                texColor = texture2D(uTexture, fTexCoord);
            }

            // Phong components
            vec4 ambient  = uAmbient * texColor;
            vec4 diffuse  = uDiffuse * diff * texColor;
            vec4 specular = uSpecular * spec;

            // --- Fresnel Enhancement for Glass (applies only to transparent objects) ---
            float finalAlpha = uAlpha;
            if (finalAlpha < 1.0) { 
                // Schlick's approximation for Fresnel Reflectance
                float cosNV = abs(dot(N, V)); 
                float R0 = 0.2; // Base reflectivity for transparent material (glass)
                float fresnelFactor = R0 + (1.0 - R0) * pow(1.0 - cosNV, 5.0);
                
                // Boost the specular component at grazing angles for visual realism
                specular.rgb *= fresnelFactor * 2.0; 
            }
            // ------------------------------------------

            vec4 color = ambient + diffuse + specular;

            gl_FragColor = vec4(color.rgb, finalAlpha);
        }
    </script>

</head>

<body>
    <canvas id="gl-canvas" width="800" height="600">
        Your browser does not support HTML5 canvas.
    </canvas>

    <div style="margin-top:10px;">
        <button onclick="orbitLeft()">Orbit Left</button>
        <button onclick="orbitRight()">Orbit Right</button>
        <button onclick="resetCamera()">Reset Camera</button>
        
        <button onclick="toggleLightOrbit()">Toggle Light Orbit</button>
    </div>
    
    <div style="margin-top:10px;">
        Shard Orbit Radius Scale: 0.5 
        <input id="shardRadiusSlider" type="range"
               min="0.5" max="1.5" step="0.05" value="1.0"
               onchange="shardRadiusFactor = event.target.valueAsNumber;">
        1.5
    </div>

    <div style="margin-top:10px;">
        Core Resolution (Triangles/Complexity):
        <button onclick="decreaseResolution()">Decrease Resolution (-)</button>
        <button onclick="increaseResolution()">Increase Resolution (+)</button>
    </div>
</body>
</html>